import React, { useState, useEffect } from 'react';
import { toastHandler } from '../../../utils/utils';
import { ToastType, PAYMENT_TYPES, TRANSFER_CONFIG } from '../../../constants/constants';
import { useAllProductsContext } from '../../../contexts/ProductsContextProvider';
import { useConfigContext } from '../../../contexts/ConfigContextProvider';
import { useCurrencyContext } from '../../../contexts/CurrencyContextProvider';
import styles from './PaymentConfigManager.module.css';

const PaymentConfigManager = () => {
  const { products: productsFromContext, updateProductsFromAdmin } = useAllProductsContext();
  const { updateProducts } = useConfigContext();
  const { formatPriceWithCode } = useCurrencyContext();
  const [localProducts, setLocalProducts] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterPaymentType, setFilterPaymentType] = useState('all');
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

  // CARGAR PRODUCTOS CON SINCRONIZACI√ìN MEJORADA
  useEffect(() => {
    console.log('üîÑ Cargando productos para configuraci√≥n de pagos:', productsFromContext?.length || 0);
    
    if (productsFromContext && productsFromContext.length > 0) {
      setLocalProducts(productsFromContext);
    } else {
      const savedConfig = localStorage.getItem('adminStoreConfig');
      if (savedConfig) {
        try {
          const parsedConfig = JSON.parse(savedConfig);
          if (parsedConfig.products && parsedConfig.products.length > 0) {
            console.log('üì¶ Cargando productos desde localStorage para pagos:', parsedConfig.products.length);
            setLocalProducts(parsedConfig.products);
            updateProductsFromAdmin(parsedConfig.products);
          }
        } catch (error) {
          console.error('Error al cargar productos desde localStorage:', error);
        }
      }
    }
  }, [productsFromContext, updateProductsFromAdmin]);

  // ESCUCHAR EVENTOS DE ACTUALIZACI√ìN DE PRODUCTOS
  useEffect(() => {
    const handleProductsUpdate = (event) => {
      const { products: updatedProducts } = event.detail;
      console.log('üì° Evento de actualizaci√≥n de productos recibido en PaymentConfigManager');
      setLocalProducts(updatedProducts);
    };

    const handleConfigUpdate = () => {
      console.log('üì° Evento de actualizaci√≥n de configuraci√≥n recibido en PaymentConfigManager');
      const savedConfig = localStorage.getItem('adminStoreConfig');
      if (savedConfig) {
        try {
          const parsedConfig = JSON.parse(savedConfig);
          if (parsedConfig.products) {
            setLocalProducts(parsedConfig.products);
          }
        } catch (error) {
          console.error('Error al cargar productos desde configuraci√≥n:', error);
        }
      }
    };

    window.addEventListener('productsUpdated', handleProductsUpdate);
    window.addEventListener('productsConfigUpdated', handleProductsUpdate);
    window.addEventListener('forceStoreUpdate', handleConfigUpdate);
    window.addEventListener('adminConfigChanged', handleConfigUpdate);

    return () => {
      window.removeEventListener('productsUpdated', handleProductsUpdate);
      window.removeEventListener('productsConfigUpdated', handleProductsUpdate);
      window.removeEventListener('forceStoreUpdate', handleConfigUpdate);
      window.removeEventListener('adminConfigChanged', handleConfigUpdate);
    };
  }, []);

  // Funci√≥n para sincronizaci√≥n completa
  const performCompleteSync = (updatedProducts) => {
    console.log('üîÑ Iniciando sincronizaci√≥n completa de configuraci√≥n de pagos...');
    
    setLocalProducts(updatedProducts);
    
    const savedConfig = localStorage.getItem('adminStoreConfig') || '{}';
    let config = {};
    
    try {
      config = JSON.parse(savedConfig);
    } catch (error) {
      console.error('Error al cargar configuraci√≥n:', error);
      config = {};
    }

    config.products = updatedProducts;
    config.lastModified = new Date().toISOString();
    localStorage.setItem('adminStoreConfig', JSON.stringify(config));
    
    updateProducts(updatedProducts);
    updateProductsFromAdmin(updatedProducts);
    
    setTimeout(() => {
      window.dispatchEvent(new CustomEvent('productsUpdated', { 
        detail: { products: updatedProducts } 
      }));
      window.dispatchEvent(new CustomEvent('forceStoreUpdate'));
      window.dispatchEvent(new CustomEvent('adminConfigChanged', { 
        detail: { products: updatedProducts, type: 'products' } 
      }));
    }, 50);

    console.log('‚úÖ Sincronizaci√≥n de configuraci√≥n de pagos completada');
  };

  const updateProductPayment = (productId, paymentType, transferFeePercentage = 5) => {
    const updatedProducts = localProducts.map(product => {
      if (product._id === productId) {
        return {
          ...product,
          paymentType,
          transferFeePercentage: parseFloat(transferFeePercentage)
        };
      }
      return product;
    });

    performCompleteSync(updatedProducts);
    setHasUnsavedChanges(true);
    
    const product = localProducts.find(p => p._id === productId);
    toastHandler(ToastType.Success, 
      `‚úÖ ${product.name}: M√©todo de pago actualizado`
    );
  };

  const updateAllProducts = (paymentType, transferFeePercentage = 5) => {
    const updatedProducts = localProducts.map(product => ({
      ...product,
      paymentType,
      transferFeePercentage: parseFloat(transferFeePercentage)
    }));

    performCompleteSync(updatedProducts);
    setHasUnsavedChanges(true);
    
    toastHandler(ToastType.Success, 
      `‚úÖ M√©todo de pago actualizado para todos los productos`
    );
  };

  // Filtrar productos
  const filteredProducts = localProducts.filter(product => {
    const matchesSearch = product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         product.category.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         product.company.toLowerCase().includes(searchTerm.toLowerCase());
    
    const productPaymentType = product.paymentType || 'both';
    const matchesFilter = filterPaymentType === 'all' || productPaymentType === filterPaymentType;
    
    return matchesSearch && matchesFilter;
  });

  // Estad√≠sticas
  const stats = {
    total: localProducts.length,
    cash: localProducts.filter(p => (p.paymentType || 'both') === 'cash').length,
    transfer: localProducts.filter(p => (p.paymentType || 'both') === 'transfer').length,
    both: localProducts.filter(p => (p.paymentType || 'both') === 'both').length
  };

  const hasChanges = localProducts.length !== productsFromContext.length || 
    JSON.stringify(localProducts) !== JSON.stringify(productsFromContext);

  return (
    <div className={styles.paymentConfigManager}>
      <div className={styles.header}>
        <h2>üí≥ Configuraci√≥n de M√©todos de Pago</h2>
        <div className={styles.headerActions}>
          {hasChanges && (
            <span className={styles.changesIndicator}>
              üü¢ Cambios aplicados en tiempo real
            </span>
          )}
        </div>
      </div>

      <div className={styles.infoBox}>
        <h4>‚ÑπÔ∏è Sistema de M√©todos de Pago</h4>
        <p>Configura qu√© m√©todos de pago acepta cada producto. Los productos con transferencia bancaria incluyen un recargo configurable. Los cambios se aplican autom√°ticamente en la tienda y en el checkout.</p>
      </div>

      {/* ESTAD√çSTICAS */}
      <div className={styles.statsContainer}>
        <div className={styles.statCard}>
          <h4>üìä Estado Actual de M√©todos de Pago</h4>
          <div className={styles.stats}>
            <div className={styles.statItem}>
              <span className={styles.statNumber}>{stats.total}</span>
              <span className={styles.statLabel}>Total Productos</span>
            </div>
            <div className={styles.statItem}>
              <span className={styles.statNumber}>{stats.cash}</span>
              <span className={styles.statLabel}>Solo Efectivo</span>
            </div>
            <div className={styles.statItem}>
              <span className={styles.statNumber}>{stats.transfer}</span>
              <span className={styles.statLabel}>Solo Transferencia</span>
            </div>
            <div className={styles.statItem}>
              <span className={styles.statNumber}>{stats.both}</span>
              <span className={styles.statLabel}>Ambos M√©todos</span>
            </div>
          </div>
        </div>
      </div>

      {/* CONTROLES MASIVOS */}
      <div className={styles.bulkActions}>
        <h4>‚ö° Configuraci√≥n Masiva</h4>
        <div className={styles.bulkControls}>
          <div className={styles.bulkRow}>
            <button 
              onClick={() => updateAllProducts('cash')}
              className="btn btn-success"
            >
              üí∞ Solo Efectivo para Todos
            </button>
            <button 
              onClick={() => updateAllProducts('transfer', 5)}
              className="btn btn-activated"
            >
              üí≥ Solo Transferencia para Todos (5%)
            </button>
            <button 
              onClick={() => updateAllProducts('both', 5)}
              className="btn btn-primary"
            >
              üí∞üí≥ Ambos M√©todos para Todos (5%)
            </button>
          </div>
        </div>
      </div>

      {/* FILTROS */}
      <div className={styles.filtersContainer}>
        <div className={styles.searchContainer}>
          <input
            type="text"
            placeholder="üîç Buscar productos..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className={`form-input ${styles.searchInput}`}
          />
        </div>

        <div className={styles.filterContainer}>
          <label>Filtrar por m√©todo de pago:</label>
          <select
            value={filterPaymentType}
            onChange={(e) => setFilterPaymentType(e.target.value)}
            className="form-select"
          >
            <option value="all">üîç Todos los m√©todos</option>
            <option value="cash">üí∞ Solo Efectivo</option>
            <option value="transfer">üí≥ Solo Transferencia</option>
            <option value="both">üí∞üí≥ Ambos M√©todos</option>
          </select>
        </div>
      </div>

      {/* LISTA DE PRODUCTOS */}
      <div className={styles.productsList}>
        <div className={styles.listHeader}>
          <h3>Productos ({filteredProducts.length})</h3>
          {hasChanges && (
            <div className={styles.changesAlert}>
              <span>üü¢ Los cambios se han aplicado en tiempo real en la tienda</span>
              <small>Ve a "üóÇÔ∏è Sistema Backup" para exportar los cambios</small>
            </div>
          )}
        </div>

        {filteredProducts.length === 0 ? (
          <div className={styles.emptyState}>
            <h3>üîç No se encontraron productos</h3>
            <p>Intenta cambiar los filtros o el t√©rmino de b√∫squeda.</p>
          </div>
        ) : (
          <div className={styles.productsGrid}>
            {filteredProducts.map(product => {
              const paymentType = product.paymentType || 'both';
              const transferFeePercentage = product.transferFeePercentage || 5;
              const transferPrice = product.price * (1 + transferFeePercentage / 100);

              return (
                <div key={product._id} className={styles.productCard}>
                  <div className={styles.productImage}>
                    <img src={product.image} alt={product.name} />
                    <div className={`${styles.paymentBadge} ${styles[`payment${paymentType}`]}`}>
                      {paymentType === 'cash' ? 'üí∞ EFECTIVO' : 
                       paymentType === 'transfer' ? 'üí≥ TRANSFERENCIA' :
                       'üí∞üí≥ AMBOS'}
                    </div>
                  </div>
                  
                  <div className={styles.productInfo}>
                    <h4>{product.name}</h4>
                    <p className={styles.productCategory}>üìÇ {product.category}</p>
                    <p className={styles.productCompany}>üè¢ {product.company}</p>
                    
                    <div className={styles.priceInfo}>
                      <div className={styles.priceRow}>
                        <span>üí∞ Efectivo:</span>
                        <span className={styles.cashPrice}>{formatPriceWithCode(product.price)}</span>
                      </div>
                      {(paymentType === 'transfer' || paymentType === 'both') && (
                        <div className={styles.priceRow}>
                          <span>üí≥ Transferencia:</span>
                          <span className={styles.transferPrice}>
                            {formatPriceWithCode(transferPrice)}
                            <small> (+{transferFeePercentage}%)</small>
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className={styles.productControls}>
                    <div className={styles.paymentTypeControl}>
                      <label>M√©todo de Pago:</label>
                      <select
                        value={paymentType}
                        onChange={(e) => updateProductPayment(product._id, e.target.value, transferFeePercentage)}
                        className="form-select"
                      >
                        <option value="both">üí∞üí≥ Ambos</option>
                        <option value="cash">üí∞ Solo Efectivo</option>
                        <option value="transfer">üí≥ Solo Transferencia</option>
                      </select>
                    </div>
                    
                    {(paymentType === 'transfer' || paymentType === 'both') && (
                      <div className={styles.feeControl}>
                        <label>Recargo Transferencia (%):</label>
                        <input
                          type="number"
                          value={transferFeePercentage}
                          onChange={(e) => updateProductPayment(product._id, paymentType, e.target.value)}
                          className="form-input"
                          min="0"
                          max="20"
                          step="0.1"
                        />
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      <div className={styles.infoSection}>
        <h3>‚ÑπÔ∏è Informaci√≥n del Sistema de Pagos</h3>
        <div className={styles.infoList}>
          <div className={styles.infoItem}>
            <strong>üí∞ Pago en Efectivo:</strong> Sin recargos adicionales, precio normal del producto
          </div>
          <div className={styles.infoItem}>
            <strong>üí≥ Transferencia Bancaria:</strong> Incluye recargo configurable por producto
          </div>
          <div className={styles.infoItem}>
            <strong>üîí Restricciones en Checkout:</strong> Las opciones de pago se habilitan/deshabilitan seg√∫n los productos en el carrito
          </div>
          <div className={styles.infoItem}>
            <strong>‚ö° Tiempo Real:</strong> Los cambios se aplican inmediatamente en la tienda y checkout
          </div>
          <div className={styles.infoItem}>
            <strong>üí± Conversi√≥n de Moneda:</strong> Los recargos se calculan seg√∫n la moneda seleccionada por el cliente
          </div>
          <div className={styles.infoItem}>
            <strong>üì± WhatsApp:</strong> El desglose completo se incluye en el mensaje de pedido
          </div>
        </div>
      </div>
    </div>
  );
};

export default PaymentConfigManager;